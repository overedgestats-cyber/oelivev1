<!doctype html>
<html lang="en">
  <!-- Meta Pixel Code -->
<script>
!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '1135930111808538');
fbq('track', 'PageView');
</script>
<noscript><img height="1" width="1" style="display:none"
src="https://www.facebook.com/tr?id=1135930111808538&ev=PageView&noscript=1"
/></noscript>
<!-- End Meta Pixel Code -->
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Account · OverEdge</title>
  <meta name="description" content="Manage your OverEdge account and subscription."/>
  <link rel="stylesheet" href="/style.css"/>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-88C4MQ3EF8"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-88C4MQ3EF8');
  </script>
</head>
<script defer src="/_vercel/speed-insights/script.js"></script>

<body>
  <header class="site-header">
    <nav class="nav">
      <a class="logo brand" href="/" aria-label="OverEdge">
        <img class="brand-img" src="/img/overedge-logo.png" alt="" />
        <span class="sr-only">OverEdge</span>
      </a>

      <div class="links">
        <a href="/free-picks">Free Picks</a>
        <a href="/pro">Pro</a>
        <a href="/pricing">Pricing</a>
        <a href="/FAQ">FAQ</a>
        <a href="/results">Results</a>
        <a href="/account" aria-current="page">Account</a>
      </div>

      <!-- Global auth controls (shared with /auth.js) -->
      <div class="auth" style="display:flex;align-items:center;gap:.5rem">
        <span id="nav-plan" class="badge pill" style="display:none"></span>
        <button id="nav-auth" class="btn small secondary" type="button">Sign In</button>
      </div>
    </nav>
  </header>

  <main>
    <section class="section">
      <h1 class="center">Your Account</h1>

      <div class="card" style="padding:1rem">
        <p><strong>Status:</strong> <span id="status">Checking…</span></p>
        <p style="margin-top:.75rem; display:flex; gap:.5rem; flex-wrap:wrap">
          <button id="googleBtn" class="btn">Continue with Google</button>
          <button id="logoutBtn" class="btn secondary" style="display:none">Sign Out</button>
        </p>
        <p class="muted">You must be signed in before subscribing.</p>
      </div>

      <div id="sub" class="card" style="margin-top:1rem; padding:1rem; display:none">
        <h3>Subscription</h3>
        <p id="subDetails"></p>
        <p style="display:flex; gap:.5rem; flex-wrap:wrap">
          <button id="refreshBtn" class="btn small" type="button">Refresh status</button>
          <a class="btn secondary small" href="/pricing">Manage / Upgrade</a>
        </p>
        <p class="muted" style="margin-top:.5rem">After Stripe checkout, return here and click “Refresh status”.</p>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <span>© <span id="y"></span> OverEdge — Data beats gut</span>
    <div class="contact">
      <a href="mailto:overedgestats@gmail.com">overedgestats@gmail.com</a>
      &nbsp;·&nbsp;
      <a href="https://www.facebook.com/profile.php?id=61579190114778" target="_blank" rel="noopener">Facebook</a>
      &nbsp;·&nbsp;
      <a href="https://www.instagram.com/overedgefootball" target="_blank" rel="noopener">@overedgefootball</a>
    </div>
  </footer>

  <!-- Firebase (modular SDK) — core account logic -->
  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

    document.getElementById('y').textContent = new Date().getFullYear();

    const statusEl   = document.getElementById('status');
    const googleBtn  = document.getElementById('googleBtn');
    const logoutBtn  = document.getElementById('logoutBtn');
    const subCard    = document.getElementById('sub');
    const subDetails = document.getElementById('subDetails');
    const refreshBtn = document.getElementById('refreshBtn');

    let appAuth = null;

    async function initFirebase() {
      const cfgRes = await fetch('/api/rpc?action=public-config');
      const cfg = (await cfgRes.json()).firebase || {};
      if (!getApps().length) initializeApp(cfg);
      appAuth = getAuth();
      return appAuth;
    }

    function setLocalUser(u) {
      if (!u) { localStorage.removeItem('oe.user'); return; }
      localStorage.setItem('oe.user', JSON.stringify(u));
    }

    async function verifyStripe(email) {
      try {
        const res = await fetch(`/api/rpc?action=verify-sub&email=${encodeURIComponent(email)}`);
        if (!res.ok) throw new Error('verify failed');
        return await res.json();
      } catch {
        return { pro: false, plan: null, status: 'unknown' };
      }
    }

    function renderAnon() {
      statusEl.textContent = 'Signed out';
      googleBtn.style.display = '';
      logoutBtn.style.display = 'none';
      subCard.style.display = 'none';
      setLocalUser(null);
    }

    function renderUser(u, sub) {
      try{
  if(sub.pro){ fbq('track','Subscribe',{subscription_plan: sub.plan || 'pro'}); }
}catch(e){}

      statusEl.textContent = `Signed in as ${u.email}`;
      googleBtn.style.display = 'none';
      logoutBtn.style.display = '';
      subCard.style.display = 'block';
      subDetails.textContent = sub.pro
        ? `Active: Pro (${sub.plan || sub.status})`
        : `Plan: Free (${sub.status})`;
      setLocalUser({ email: u.email, uid: u.uid, pro: !!sub.pro, plan: sub.plan || null });
    }

    googleBtn.addEventListener('click', async () => {
      try {
        const provider = new GoogleAuthProvider();
        provider.setCustomParameters({ prompt: 'select_account' });
        await signInWithPopup(appAuth, provider);
      } catch {
        alert('Google sign-in failed.');
      }
    });

    logoutBtn.addEventListener('click', async () => {
      try { await signOut(appAuth); } catch {}
    });

    refreshBtn.addEventListener('click', async () => {
      const u = appAuth.currentUser;
      if (!u) return alert('Please sign in first.');
      const sub = await verifyStripe(u.email);
      renderUser(u, sub);
      alert(sub.pro ? 'Pro is active ✅' : 'No active subscription found.');
    });

    (async () => {
      await initFirebase();
      onAuthStateChanged(appAuth, async (user) => {
        if (!user) return renderAnon();
        const sub = await verifyStripe(user.email);
        renderUser(user, sub);
      });
    })();
  </script>

  <!-- Shared navbar auth module -->
  <script type="module" src="/auth.js"></script>
  <script>
  function fireSubscribeOnce(plan){
    try{
      if (localStorage.getItem('fb_subscribed') === '1') return;
      if (typeof fbq === 'function') fbq('track', 'Subscribe', { plan });
      localStorage.setItem('fb_subscribed','1');
    }catch{}
  }
  // Call this right after you render a user with sub.pro === true
  // renderUser(user, sub) { ... if(sub.pro) fireSubscribeOnce(sub.plan); ... }
</script>

</body>
</html>
