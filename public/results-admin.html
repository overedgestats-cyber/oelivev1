<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Results Admin · OverEdge</title>
  <meta name="description" content="Admin: manage Free Picks results."/>
  <link rel="stylesheet" href="/style.css"/>
  <style>
    .admin-note{font-size:.92rem;opacity:.8}
    .row{border:1px solid #e5e7eb;border-radius:12px;padding:.75rem;margin:.5rem 0}
    .grid{display:grid;gap:.5rem}
    @media (min-width:700px){ .grid{grid-template-columns:2fr 1fr 1fr 1fr} }
    .muted-sm{opacity:.75;font-size:.92rem}
    input[type="text"]{padding:.45rem .6rem;border:1px solid #e2e8f0;border-radius:8px;width:100%}
    select{padding:.45rem .6rem;border:1px solid #e2e8f0;border-radius:8px}
  </style>

  <!-- Google tag -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-88C4MQ3EF8"></script>
  <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);} gtag('js',new Date()); gtag('config','G-88C4MQ3EF8');</script>
</head>
<body>
<header class="site-header">
  <nav class="nav">
    <a class="logo brand" href="/" aria-label="OverEdge">
      <img class="brand-img" src="/img/overedge-logo.png" alt="" />
      <span class="sr-only">OverEdge</span>
    </a>
    <div class="links">
      <a href="/free-picks">Free Picks</a>
      <a href="/pro">Pro</a>
      <a href="/pricing">Pricing</a>
      <a href="/FAQ">FAQ</a>
      <a href="/results">Results</a>
      <a href="/account">Account</a>
    </div>
  </nav>
</header>

<main class="section" style="max-width:1000px">
  <h1>Results Admin</h1>
  <p class="admin-note">Signed-in admins can sync today’s picks (status: <em>pending</em>) and then mark outcomes when games finish.</p>

  <div id="gate" class="card" style="padding:1rem;margin:.5rem 0">
    <div id="gate-status">Checking sign-in…</div>
    <p style="margin-top:.5rem">
      <button id="btn-login" class="btn">Continue with Google</button>
      <button id="btn-logout" class="btn secondary" style="display:none">Sign Out</button>
    </p>
  </div>

  <div id="admin" style="display:none">
    <div class="card" style="padding:1rem;margin:.5rem 0">
      <h3>1) Sync today’s Free Picks → Draft</h3>
      <p class="muted">Pulls from /api/rpc?action=free-picks and saves/updates docs in <code>free_results</code> (status <strong>pending</strong>).</p>
      <p><button id="btn-sync" class="btn small">Sync today’s Free Picks</button></p>
    </div>

    <div class="card" style="padding:1rem;margin:.5rem 0">
      <h3>2) Settle pending picks</h3>
      <div id="pending">Loading…</div>
    </div>
  </div>
</main>

<footer class="site-footer">
  <span>© <span id="y"></span> OverEdge — Data beats gut</span>
</footer>

<script>document.getElementById('y').textContent=new Date().getFullYear();</script>

<!-- Firebase Admin UI -->
<script type="module">
  import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import { getFirestore, collection, doc, setDoc, updateDoc, getDocs, getDoc, query, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  // ⚠️ EDIT: same emails as in firestore.rules
  const ADMIN_EMAILS = ["you@example.com","teammate@example.com"];

  function tzGuess(){try{return Intl.DateTimeFormat().resolvedOptions().timeZone||"Europe/Sofia";}catch{return "Europe/Sofia";}}
  function ymd(d=new Date()){ return new Date(d).toISOString().slice(0,10); }

  const gate = document.getElementById('gate');
  const gateStatus = document.getElementById('gate-status');
  const btnLogin = document.getElementById('btn-login');
  const btnLogout= document.getElementById('btn-logout');
  const admin = document.getElementById('admin');
  const pendingEl = document.getElementById('pending');
  const btnSync = document.getElementById('btn-sync');

  let auth=null, db=null, currentUser=null;

  async function init(){
    const cfg = await fetch('/api/rpc?action=public-config').then(r=>r.json()).then(d=>d.firebase||{});
    if(!getApps().length) initializeApp(cfg);
    auth = getAuth();
    db = getFirestore();

    onAuthStateChanged(auth, u=>{
      currentUser = u || null;
      renderGate();
      if (isAdmin()) { admin.style.display='block'; loadPending(); }
      else { admin.style.display='none'; }
    });

    btnLogin.addEventListener('click', async ()=>{
      try{
        const p = new GoogleAuthProvider();
        p.setCustomParameters({ prompt:'select_account' });
        await signInWithPopup(auth, p);
      }catch{ alert('Google sign-in failed.'); }
    });
    btnLogout.addEventListener('click', async ()=>{ try{ await signOut(auth); }catch{} });

    btnSync.addEventListener('click', syncToday);
  }

  function isAdmin(){
    return !!(currentUser && ADMIN_EMAILS.includes((currentUser.email||'').toLowerCase()));
  }

  function renderGate(){
    if (!currentUser){
      gateStatus.textContent = 'Signed out.';
      btnLogin.style.display='';
      btnLogout.style.display='none';
      return;
    }
    gateStatus.textContent = `Signed in as ${currentUser.email}${isAdmin()?' (admin)':''}`;
    btnLogin.style.display='none';
    btnLogout.style.display='';
  }

  async function syncToday(){
    try{
      btnSync.disabled = true;
      btnSync.textContent = 'Syncing…';
      const res = await fetch(`/api/rpc?action=free-picks&tz=${encodeURIComponent(tzGuess())}`);
      const data = await res.json();
      const picks = Array.isArray(data?.picks)? data.picks : [];
      const date = data?.date || ymd();

      for (const p of picks){
        const id = `${date}-${p.fixtureId || `${(p.home||'').slice(0,12)}-${(p.away||'').slice(0,12)}`}`.replace(/\s+/g,'_');
        const ref = doc(collection(db,'free_results'), id);
        await setDoc(ref, {
          date, fixtureId: p.fixtureId||null, matchTime: p.matchTime||'',
          country: p.country||'', league: p.league||'',
          home: p.home||'', away: p.away||'',
          market: p.market||'', confidencePct: p.confidencePct||null,
          odds: (p.odds!=null ? Number(p.odds) : null),
          reasoning: p.reasoning||'',
          status: 'pending',
          updatedAt: serverTimestamp(),
          createdAt: serverTimestamp()
        }, { merge: true });
      }
      alert(`Synced ${picks.length} pick(s) for ${date}.`);
      await loadPending();
    }catch(e){
      alert('Sync failed.');
    }finally{
      btnSync.disabled=false; btnSync.textContent='Sync today’s Free Picks';
    }
  }

  async function loadPending(){
    pendingEl.textContent = 'Loading…';
    const q = query(collection(db,'free_results'), orderBy('date','desc'), limit(60));
    const snap = await getDocs(q);
    const rows = snap.docs.map(d=>({id:d.id, ...d.data()})).filter(r=>(r.status||'').toLowerCase()!=='win' && (r.status||'').toLowerCase()!=='lose' && (r.status||'').toLowerCase()!=='push');

    if (!rows.length){ pendingEl.innerHTML = '<p class="muted">No pending picks.</p>'; return; }

    pendingEl.innerHTML = rows.map(r=>`
      <div class="row">
        <div style="font-weight:800">${r.home} vs ${r.away}</div>
        <div class="muted-sm">${r.date} · ${[r.country,r.league].filter(Boolean).join(' — ')} · ${r.market} · Conf ${r.confidencePct??'-'}% ${r.odds?`· Odds ${Number(r.odds).toFixed(2)}`:''}</div>

        <div class="grid" style="margin-top:.5rem">
          <div>
            <label class="muted-sm">Status</label><br/>
            <select data-id="${r.id}" class="st">
              ${['pending','win','lose','push'].map(s=>`<option value="${s}" ${String(r.status||'pending').toLowerCase()===s?'selected':''}>${s.toUpperCase()}</option>`).join('')}
            </select>
          </div>
          <div>
            <label class="muted-sm">FT Score (e.g., 2-1)</label>
            <input type="text" placeholder="e.g. 2-1" class="ft" data-id="${r.id}" value="${r.finalScore||''}"/>
          </div>
          <div>
            <label class="muted-sm">Odds</label>
            <input type="text" placeholder="2.05" class="od" data-id="${r.id}" value="${r.odds!=null?Number(r.odds):''}"/>
          </div>
          <div>
            <label class="muted-sm">Save</label><br/>
            <button class="btn small sv" data-id="${r.id}">Save</button>
          </div>
        </div>
      </div>
    `).join('');

    pendingEl.querySelectorAll('.sv').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const id = btn.getAttribute('data-id');
        const st = pendingEl.querySelector(`.st[data-id="${id}"]`).value;
        const ft = pendingEl.querySelector(`.ft[data-id="${id}"]`).value.trim();
        const od = pendingEl.querySelector(`.od[data-id="${id}"]`).value.trim();
        try{
          await updateDoc(doc(collection(db,'free_results'), id), {
            status: st.toLowerCase(),
            finalScore: ft || null,
            odds: od ? Number(od) : null,
            updatedAt: serverTimestamp()
          });
          btn.textContent = 'Saved ✓';
          setTimeout(()=>{ btn.textContent='Save'; }, 1200);
        }catch{ alert('Save failed.'); }
      });
    });
  }

  init().catch(()=> alert('Init failed'));
</script>
</body>
</html>
