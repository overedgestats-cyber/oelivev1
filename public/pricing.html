<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Pricing · OverEdge</title>
  <link rel="stylesheet" href="/style.css"/>

  <style>
    .pricing-wrap{max-width:980px;margin:0 auto}
    .compare{display:grid;gap:12px;grid-template-columns:1fr 1fr}
    .compare .col{padding:14px}
    .compare h3{margin:.25rem 0}
    .compare ul{margin:.25rem 0 0;padding-left:18px}
    .plans{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}
    .plan{position:relative;display:flex;flex-direction:column;gap:.6rem}
    .plan h3{margin:0 0 .25rem 0}
    .plan .badge{position:absolute;top:12px;right:12px;font-size:.75rem;padding:4px 8px;border:1px solid #2a3250;border-radius:999px;background:#141826}
    .muted{opacity:.8}
    .features{margin:.25rem 0 0;padding-left:18px}
    .btn.block{display:block;width:100%;text-align:center}
    .msg{min-height:1.25rem}
    .price-line{display:flex;align-items:baseline;gap:.5rem}
    .price{font-size:1.25rem;font-weight:700}
    .save{font-size:.85rem;opacity:.85}
    .helper{margin-top:24px}
    @media (max-width:720px){ .compare{grid-template-columns:1fr} }
    @media (min-width:1200px){ .pricing-wrap{max-width:1200px;} .plans{grid-template-columns:repeat(4,1fr);} }
  </style>
</head>
<body>
<header>
  <nav>
    <a href="/home.html">Home</a>
    <a href="/free-picks.html">Free Picks</a>
    <a href="/pro.html">Pro</a>
    <a href="/pricing.html">Pricing</a>
    <a href="/about.html">About</a>
    <a href="/FAQ.html">FAQ</a>
    <span style="float:right">
      <button id="loginBtn" class="btn">Sign in</button>
      <button id="logoutBtn" class="btn" hidden>Sign out</button>
      <small id="userEmail" style="margin-left:.5rem"></small>
    </span>
  </nav>
</header>

<main class="pricing-wrap">
  <h1>Choose your edge</h1>

  <!-- Free vs Pro comparison -->
  <section class="compare">
    <div class="card col">
      <h3>Free</h3>
      <ul>
        <li>Up to two daily picks (European domestic)</li>
        <li>Simple reasoning with expected goals</li>
        <li>No sign-in required</li>
      </ul>
    </div>
    <div class="card col">
      <h3>Pro <span class="muted">— everything in Free, plus:</span></h3>
      <ul>
        <li><b>Full Pro Board</b> (ranked slate for allowed leagues)</li>
        <li><b>Hero Bet</b> (single highest edge pick)</li>
        <li><b>Calibrated confidence %</b> (not raw scores)</li>
        <li>Cards & corners guidance</li>
        <li>Members-only API endpoints</li>
      </ul>
    </div>
  </section>

  <h2 style="margin-top:1rem">Go Pro</h2>

  <!-- Plans -->
  <section class="plans">
    <!-- Weekly -->
    <div class="card plan">
      <span class="badge">Start here</span>
      <h3>Pro — Weekly</h3>
      <div class="price-line">
        <span id="price_weekly" class="price">—</span>
        <span id="save_weekly" class="save"></span>
      </div>
      <ul class="features">
        <li>Full Pro Board access</li>
        <li>Hero Bet</li>
      </ul>
      <button class="btn block subscribe" data-plan="weekly">Subscribe Weekly</button>
      <div class="muted msg" id="msg_weekly"></div>
    </div>

    <!-- Monthly -->
    <div class="card plan">
      <span class="badge">Popular</span>
      <h3>Pro — Monthly</h3>
      <div class="price-line">
        <span id="price_monthly" class="price">—</span>
        <span id="save_monthly" class="save"></span>
      </div>
      <ul class="features">
        <li>Full Pro Board access</li>
        <li>Hero Bet</li>
      </ul>
      <button class="btn block subscribe" data-plan="monthly">Subscribe Monthly</button>
      <div class="muted msg" id="msg_monthly"></div>
    </div>

    <!-- Quarterly -->
    <div class="card plan">
      <span class="badge">Save more</span>
      <h3>Pro — Quarterly</h3>
      <div class="price-line">
        <span id="price_quarterly" class="price">—</span>
        <span id="save_quarterly" class="save"></span>
      </div>
      <ul class="features">
        <li>Full Pro Board access</li>
        <li>Hero Bet</li>
      </ul>
      <button class="btn block subscribe" data-plan="quarterly">Subscribe Quarterly</button>
      <div class="muted msg" id="msg_quarterly"></div>
    </div>

    <!-- Yearly -->
    <div class="card plan">
      <span class="badge">Best value</span>
      <h3>Pro — Yearly</h3>
      <div class="price-line">
        <span id="price_yearly" class="price">—</span>
        <span id="save_yearly" class="save"></span>
      </div>
      <ul class="features">
        <li>Full Pro Board access</li>
        <li>Hero Bet</li>
      </ul>
      <button class="btn block subscribe" data-plan="yearly">Subscribe Yearly</button>
      <div class="muted msg" id="msg_yearly"></div>
    </div>
  </section>

  <div class="card helper" id="post-checkout-card" style="display:none">
    <h3>Thanks! Activating Pro…</h3>
    <p class="muted" id="post-checkout-message">Waiting for confirmation…</p>
  </div>

  <div class="card helper">
    <h3>Already subscribed?</h3>
    <p class="muted">Sign in with the same email and open the Pro page.</p>
    <a class="btn" href="/pro.html">Go to Pro Board</a>
  </div>
</main>

<footer>
  © OverEdge ·
  <a href="mailto:overedgestats@gmail.com">overedgestats@gmail.com</a> ·
  <a href="https://www.facebook.com/profile.php?id=61579190114778#" target="_blank" rel="noopener noreferrer">Facebook</a> ·
  <a href="https://www.instagram.com/overedgefootball?igsh=MXJsb3U5ajR0cXR0bw%3D%3D&utm_source=qr" target="_blank" rel="noopener noreferrer">Instagram</a>
</footer>

<!-- Firebase config must set: window.FIREBASE_CONFIG = { ... } -->
<script src="/firebase-config.js"></script>

<!-- Stripe.js -->
<script src="https://js.stripe.com/v3/"></script>

<!-- Pricing + Checkout (login required, no keys hard-coded) -->
<script type="module">
  // ---------- Firebase via CDN ----------
  import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
  import {
    getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut
  } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

  const firebaseConfig = window.FIREBASE_CONFIG;
  const app  = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
  const auth = getAuth(app);

  // ---------- Public config (Stripe publishable key from env via API) ----------
  let _stripe = null;
  async function getStripe() {
    if (_stripe) return _stripe;
    const cfg = await fetch('/api/public-config').then(r => r.json());
    if (!cfg?.stripePk) throw new Error('Stripe publishable key missing on server.');
    _stripe = Stripe(cfg.stripePk);
    return _stripe;
  }

  // ---------- Static price display & savings ----------
  const DISPLAY_PRICES = { currency: "EUR", weekly: 6.99, monthly: 17.99, quarterly: 44.99, yearly: 146.99 };
  const SYMBOLS = { USD:"$", EUR:"€", GBP:"£" };
  function fmt(amount, currency){ if (amount==null) return "—"; const s = SYMBOLS[currency]||""; return s?`${s}${amount.toFixed(2)}`:`${amount.toFixed(2)} ${currency||""}`.trim(); }
  function monthlyEquivalent(plan, dp){
    switch(plan){
      case "weekly":    return (dp.weekly ?? 0) * 52 / 12;
      case "monthly":   return (dp.monthly ?? 0);
      case "quarterly": return (dp.quarterly ?? 0) / 3;
      case "yearly":    return (dp.yearly ?? 0) / 12;
      default: return 0;
    }
  }
  function savingsPercent(plan, dp){
    const mon = dp.monthly, eq = monthlyEquivalent(plan, dp);
    if (!mon || !eq) return null; return Math.round((1 - (eq / mon)) * 100);
  }
  function setPriceUI(plan){
    const p = document.getElementById(`price_${plan}`);
    const s = document.getElementById(`save_${plan}`);
    if (p) p.textContent = fmt(DISPLAY_PRICES[plan], DISPLAY_PRICES.currency);
    const sp = savingsPercent(plan, DISPLAY_PRICES);
    if (s) s.textContent = sp ? `Save ${sp}% vs monthly` : "";
  }
  ["weekly","monthly","quarterly","yearly"].forEach(setPriceUI);

  // ---------- Auth UI ----------
  const loginBtn  = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const userEmail = document.getElementById('userEmail');

  function setAuthUI(user){
    if (user) { loginBtn.hidden = true; logoutBtn.hidden = false; userEmail.textContent = user.email || ""; }
    else { loginBtn.hidden = false; logoutBtn.hidden = true; userEmail.textContent = ""; }
  }
  onAuthStateChanged(auth, setAuthUI);

  loginBtn?.addEventListener('click', async () => {
    try { await signInWithPopup(auth, new GoogleAuthProvider()); }
    catch (e) { alert('Sign-in failed: ' + (e?.message || e)); }
  });
  logoutBtn?.addEventListener('click', async () => {
    try { await signOut(auth); }
    catch (e) { alert('Sign-out failed: ' + (e?.message || e)); }
  });

  // ---------- Checkout (requires login) ----------
  async function startCheckout(plan, msgEl){
    try {
      const user = auth.currentUser;
      if (!user) { msgEl.textContent = "Please sign in first."; loginBtn?.focus(); return; }
      msgEl.textContent = "Preparing Checkout…";
      const idToken = await user.getIdToken();

      const resp = await fetch("/api/stripe/create-checkout-session", {
        method: "POST",
        headers: { "Content-Type": "application/json", "Authorization": "Bearer " + idToken },
        body: JSON.stringify({ plan }) // 'weekly' | 'monthly' | 'quarterly' | 'yearly'
      });

      // Read as text first so we can display any HTML error from Vercel
      const raw = await resp.text();
      let data = null; try { data = JSON.parse(raw); } catch(_) {}

      if (!resp.ok) throw new Error((data && (data.message || data.error)) || raw.slice(0,160));
      if (!data?.id) throw new Error("No session id from server.");

      const stripe = await getStripe();
      const { error } = await stripe.redirectToCheckout({ sessionId: data.id });
      if (error) throw error;
    } catch (e) {
      msgEl.textContent = `Error: ${e.message || e}`;
      console.error(e);
    }
  }

  document.querySelectorAll(".subscribe").forEach(btn => {
    btn.addEventListener("click", () => {
      const plan = btn.dataset.plan;
      const msgEl = document.getElementById(`msg_${plan}`);
      startCheckout(plan, msgEl);
    });
  });

  // ---------- Post-checkout: poll for activation & redirect ----------
  (function pollActivation(){
    const params = new URLSearchParams(location.search);
    if (!params.get('session_id')) return;

    document.getElementById('post-checkout-card').style.display = 'block';
    const msg = document.getElementById('post-checkout-message');

    async function tick() {
      const user = auth.currentUser;
      if (!user) { msg.textContent = 'Please sign in to finalize activation…'; return setTimeout(tick, 1500); }
      const token = await user.getIdToken(true);
      const r = await fetch('/api/subscription/status', { headers: { Authorization: 'Bearer ' + token }});
      if (!r.ok) return setTimeout(tick, 2000);
      const s = await r.json().catch(()=>null);
      if (s?.active) location.href = '/pro.html';
      else { msg.textContent = 'Still waiting for confirmation…'; setTimeout(tick, 2000); }
    }
    tick();
  })();
</script>
</body>
</html>


