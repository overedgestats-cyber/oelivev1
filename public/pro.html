<!doctype html>
<html lang="en">
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-88C4MQ3EF8"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-88C4MQ3EF8');
  </script>
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Pro · OverEdge</title>
    <link rel="stylesheet" href="/style.css"/>

    <!-- Favicon -->
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <link rel="alternate icon" href="/og.png" type="image/png">
  </head>
  <body>
    <header>
      <nav>
        <a href="/home.html">Home</a>
        <a href="/free-picks.html">Free Picks</a>
        <a href="/pro.html">Pro</a>
        <a href="/pricing.html">Pricing</a>
        <a href="/about.html">About</a>
        <a href="/FAQ.html">FAQ</a>

        <span style="float:right; line-height:1.2; text-align:right">
          <button id="loginBtn" class="btn">Sign in</button>

          <span id="userBox" style="display:none">
            <small id="userEmail"></small><br/>
            <a id="accountLink" href="/account.html">Account</a>
          </span>

          <button id="logoutBtn" class="btn" hidden>Sign out</button>
        </span>
      </nav>
    </header>

    <main>
      <h1>Pro Board</h1>
      <div id="requirePro" class="card">Checking your subscription…</div>
    </main>

    <footer>
      © OverEdge ·
      <a href="mailto:overedgestats@gmail.com">overedgestats@gmail.com</a> ·
      <a href="https://www.facebook.com/profile.php?id=61579190114778#" target="_blank" rel="noopener noreferrer">Facebook</a> ·
      <a href="https://www.instagram.com/overedgefootball?igsh=MXJsb3U5ajR0cXR0bw%3D%3D&utm_source=qr" target="_blank" rel="noopener noreferrer">Instagram</a>
    </footer>

    <!-- Firebase config (sets window.FIREBASE_CONFIG) -->
    <script src="/firebase-config.js"></script>
    <!-- Firebase helpers (exports: watchAuth, getToken, signIn, signOutUser) -->
    <script type="module" src="/firebase-init.js"></script>
    <!-- App logic (used elsewhere, cache-busted) -->
    <script type="module" src="/app.js?v=12"></script>

    <!-- Inline Pro guard: import module API directly -->
    <script type="module">
      import { watchAuth, getToken, signIn, signOutUser } from '/firebase-init.js';

      const statusBox   = document.getElementById('requirePro');
      const loginBtn    = document.getElementById('loginBtn');
      const logoutBtn   = document.getElementById('logoutBtn');
      const userBox     = document.getElementById('userBox');
      const userEmailEl = document.getElementById('userEmail');

      loginBtn.addEventListener('click',  () => signIn().catch(console.error));
      logoutBtn.addEventListener('click', () => signOutUser().catch(console.error));

      function renderBoard(data) {
        const wrap = document.createElement('div');
        wrap.id = 'proBoard';
        if (!data || !Array.isArray(data.items) || !data.items.length) {
          wrap.innerHTML = '<div class="card">No qualifying fixtures for this date.</div>';
        } else {
          wrap.innerHTML = data.items.map(it => {
            const top = (it.topBets && it.topBets[0]) || null;
            const when = new Date(it.kickoff).toLocaleString();
            const pick = top ? `${top.market}: <b>${top.pick}</b> · <span>${top.confidence}%</span>` : '';
            return `
              <div class="card" style="margin-bottom:12px">
                <div><small>${when}</small></div>
                <div><strong>${it.home}</strong> vs <strong>${it.away}</strong></div>
                <div><small>${it.competition || (it.league && it.league.name) || ''}</small></div>
                ${pick ? `<div style="margin-top:6px">${pick}</div>` : ''}
              </div>`;
          }).join('');
        }
        statusBox.insertAdjacentElement('afterend', wrap);
      }

      // React to auth and gate the board
      watchAuth(async (user) => {
        if (!user) {
          userBox.style.display = 'none';
          logoutBtn.hidden = true;
          loginBtn.hidden  = false;
          statusBox.textContent = 'Please sign in to view the Pro Board.';
          return;
        }

        userBox.style.display = '';
        logoutBtn.hidden = false;
        loginBtn.hidden  = true;
        userEmailEl.textContent = user.email || '';

        try {
          const token = await getToken();
          // cache-bust to dodge CDN 304s
          const st = await fetch('/api/subscription/status?t=' + Date.now(), {
            headers: { Authorization: 'Bearer ' + token }
          });

          if (!st.ok) {
            const txt = await st.text().catch(()=> '');
            statusBox.textContent = 'Could not verify subscription (' + st.status + ').';
            console.warn('sub status failed:', st.status, txt);
            return;
          }

          const { active } = await st.json();
          if (!active) {
            statusBox.textContent = 'No active subscription.';
            return;
          }

          statusBox.textContent = 'Loading Pro Board…';
          const pb = await fetch('/api/pro-board', {
            headers: { Authorization: 'Bearer ' + token }
          });

          if (!pb.ok) {
            const txt = await pb.text().catch(()=> '');
            statusBox.textContent = 'Failed to load Pro Board (' + pb.status + ').';
            console.warn('pro-board failed:', pb.status, txt);
            return;
          }

          const data = await pb.json();
          statusBox.style.display = 'none';
          renderBoard(data);
        } catch (e) {
          console.error(e);
          statusBox.textContent = 'Error checking subscription.';
        }
      });
    </script>
  </body>
</html>
