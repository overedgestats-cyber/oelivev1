<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OverEdge – Pro</title>
  <link rel="stylesheet" href="/app.css" />
</head>
<body>
  <header class="site-header">
    <nav class="nav">
      <a class="brand" href="/home.html">OverEdge</a>
      <a href="/free-picks.html">Free Picks</a>
      <a class="active" href="/pro.html">Pro</a>
      <a href="/pricing.html">Pricing</a>
      <a href="/about.html">About</a>
      <a href="/faq.html">FAQ</a>
      <span class="spacer"></span>
      <span id="nav-user">Account</span>
      <span id="nav-auth"></span>
    </nav>
  </header>

  <main class="container">
    <h1>Pro Board &amp; Hero</h1>

    <div class="toolbar">
      <label>Date: <input id="date" type="date" /></label>
      <button id="btn-reload" class="btn">Reload</button>
    </div>

    <div id="gate" class="card warn" style="display:none;">
      <h3>Login required</h3>
      <p>Sign in with Google and make sure you have an active subscription.</p>
      <div class="actions">
        <button class="btn" id="btn-signin">Sign in</button>
        <a class="btn" href="/pricing.html">View Pricing</a>
      </div>
    </div>

    <section id="hero" class="card" style="display:none;"></section>

    <section id="board">
      <h2>Board</h2>
      <div id="board-status" class="muted">Loading…</div>
      <div id="board-list"></div>
    </section>
  </main>

  <script type="module" src="/app.js"></script>
  <script>
    const elDate   = document.querySelector('#date');
    const elReload = document.querySelector('#btn-reload');
    const elGate   = document.querySelector('#gate');
    const elHero   = document.querySelector('#hero');
    const elBoardS = document.querySelector('#board-status');
    const elBoardL = document.querySelector('#board-list');
    const elSignIn = document.querySelector('#btn-signin');

    const today = new Date().toISOString().slice(0, 10);
    elDate.value = today;

    elSignIn.addEventListener('click', async () => { if (window.signIn) window.signIn(); });

    function showGate(show) {
      elGate.style.display = show ? '' : 'none';
      elHero.style.display = show ? 'none' : '';
    }

    async function authedFetch(path) {
      const u = window.$user && window.$user();
      if (!u) {
        const err = new Error('not_signed_in');
        err.status = 401;
        throw err;
      }
      const token = await u.getIdToken();
      const r = await fetch(path, { headers: { Authorization: `Bearer ${token}` } });
      if (!r.ok) {
        const err = new Error(`HTTP ${r.status}`);
        err.status = r.status;
        try { err.body = await r.json(); } catch {}
        throw err;
      }
      return r.json();
    }

    // ---------- HERO ----------
    async function loadHero() {
      elHero.style.display = 'none';
      try {
        const data = await authedFetch(`/api/hero-bet?date=${elDate.value}`);
        const h = data && data.hero;
        if (!h) { elHero.innerHTML = ''; return; }
        elHero.style.display = '';
        const when = h.kickoff ? new Date(h.kickoff).toLocaleString() : '';
        const match = `${h.home} vs ${h.away}`;
        elHero.innerHTML = `
          <h2>Hero Bet of the Day</h2>
          <p class="muted">${when} · ${h.league || ''}</p>
          <p><strong>${match}</strong></p>
          <p><strong>${h.market}:</strong> ${h.pick} · <strong>Confidence:</strong> ${h.confidence}%</p>
          <p>${h.reasoning || ''}</p>
        `;
      } catch (e) {
        if (e.status === 401) showGate(true);
      }
    }

    // ---------- BOARD ----------
    function rowHTML(it) {
      const top = (it.topBets && it.topBets[0]) || null;
      const when = it.kickoff ? new Date(it.kickoff).toLocaleString() : '';
      const pick = top ? `${top.market}: ${top.pick} (${top.confidence}%)` : '—';
      const reason = (top && top.reason) ? top.reason : '';
      return `
        <div class="row">
          <div class="col when">${when}</div>
          <div class="col league">${(it.league && it.league.name) || it.competition || ''}</div>
          <div class="col match"><strong>${it.home}</strong> vs <strong>${it.away}</strong></div>
          <div class="col pick">${pick}</div>
          <div class="col reason muted">${reason}</div>
        </div>
      `;
    }

    // Map /api/pro-board (grouped) -> flat items for this UI
    function buildItemsFromProBoard(resp) {
      const groups = Array.isArray(resp && resp.data) ? resp.data : [];
      const items = [];
      for (const g of groups) {
        const leagueName = g.league || '';
        const fixtures = Array.isArray(g.fixtures) ? g.fixtures : [];
        for (const fx of fixtures) {
          const bestList = (fx && fx.markets && Array.isArray(fx.markets.best)) ? fx.markets.best.filter(Boolean) : [];
          const reasonByMarket = {
            'OU 2.5':  fx && fx.markets && fx.markets.ou25 ? fx.markets.ou25.reason : '',
            'BTTS':    fx && fx.markets && fx.markets.btts ? fx.markets.btts.reason : '',
            '1X2':     fx && fx.markets && fx.markets.oneX2 ? fx.markets.oneX2.reason : '',
            'Cards':   fx && fx.markets && fx.markets.cards ? fx.markets.cards.reason : '',
            'Corners': fx && fx.markets && fx.markets.corners ? fx.markets.corners.reason : '',
          };
          const topBets = bestList.map(b => ({
            market: b.market,
            pick: b.pick,
            confidence: b.confidence,
            reason: reasonByMarket[b.market] || ''
          })).sort((a, b) => b.confidence - a.confidence);

          items.push({
            kickoff: fx.kickoff,
            league: { name: leagueName },
            home: fx.home ? fx.home.name : '',
            away: fx.away ? fx.away.name : '',
            topBets
          });
        }
      }
      items.sort((a, b) => new Date(a.kickoff) - new Date(b.kickoff));
      return items;
    }

    async function loadBoard() {
      elBoardS.textContent = 'Loading…';
      elBoardL.innerHTML = '';
      try {
        const data = await authedFetch(`/api/pro-board?date=${elDate.value}&includeSecondary=1&strictOnly=1&minGames=8`);
        const items = buildItemsFromProBoard(data);
        if (!items.length) {
          elBoardS.textContent = 'No fixtures for this date.';
          return;
        }
        elBoardS.textContent = '';
        elBoardL.innerHTML = `
          <div class="row head">
            <div class="col when">Kickoff</div>
            <div class="col league">League</div>
            <div class="col match">Match</div>
            <div class="col pick">Model Pick</div>
            <div class="col reason">Why</div>
          </div>
          ${items.map(rowHTML).join('')}
        `;
      } catch (e) {
        if (e.status === 401) {
          showGate(true);
          elBoardS.textContent = 'Sign in and subscribe to view the Pro board.';
        } else {
          elBoardS.textContent = 'Could not load board.';
        }
      }
    }

    async function loadAll() {
      showGate(false);
      await Promise.allSettled([loadHero(), loadBoard()]);
    }

    document.addEventListener('authchange', () => loadAll());
    elReload.addEventListener('click', () => loadAll());
    elDate.addEventListener('change', () => loadAll());
    loadAll();
  </script>
</body>
</html>
