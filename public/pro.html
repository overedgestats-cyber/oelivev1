<!doctype html>
<html lang="en">
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-88C4MQ3EF8"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-88C4MQ3EF8');
  </script>
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Pro · OverEdge</title>
    <link rel="stylesheet" href="/style.css"/>

    <!-- Favicon -->
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <link rel="alternate icon" href="/og.png" type="image/png">
  </head>
  <body>
    <header>
      <nav>
        <a href="/home.html">Home</a>
        <a href="/free-picks.html">Free Picks</a>
        <a href="/pro.html">Pro</a>
        <a href="/pricing.html">Pricing</a>
        <a href="/about.html">About</a>
        <a href="/FAQ.html">FAQ</a>

        <span style="float:right; line-height:1.2; text-align:right">
          <button id="loginBtn" class="btn">Sign in</button>

          <span id="userBox" style="display:none">
            <small id="userEmail"></small><br/>
            <a id="accountLink" href="/account.html">Account</a>
          </span>

          <button id="logoutBtn" class="btn" hidden>Sign out</button>
        </span>
      </nav>
    </header>

    <main>
      <h1>Pro Board</h1>
      <div id="requirePro" class="card">Checking your subscription...</div>

      <!-- Hero Pick (shown only after Pro check passes) -->
      <section id="heroSection" class="card" style="display:none; margin-top:16px;">
        <div style="display:flex; align-items:center; gap:8px;">
          <strong>Hero Pick</strong>
          <a href="#" id="loadHero" class="btn" style="margin-left:auto;">Load Hero Pick</a>
        </div>
        <div id="heroBet" style="margin-top:8px;"></div>
      </section>
    </main>

    <footer>
      © OverEdge ·
      <a href="mailto:overedgestats@gmail.com">overedgestats@gmail.com</a> ·
      <a href="https://www.facebook.com/profile.php?id=61579190114778#" target="_blank" rel="noopener noreferrer">Facebook</a> ·
      <a href="https://www.instagram.com/overedgefootball?igsh=MXJsb3U5ajR0cXR0bw%3D%3D&utm_source=qr" target="_blank" rel="noopener noreferrer">Instagram</a>
    </footer>

    <!-- Firebase config (sets window.FIREBASE_CONFIG) -->
    <script src="/firebase-config.js"></script>
    <!-- Firebase helpers (exports: watchAuth, getToken, signIn, signOutUser) -->
    <script type="module" src="/firebase-init.js"></script>
    <!-- App helpers (optional, safe to include) -->
    <script type="module" src="/app.js?v=12"></script>

    <!-- Inline Pro logic (no nested backticks) -->
    <script type="module">
      import { watchAuth, getToken, signIn, signOutUser } from '/firebase-init.js';

      const statusBox    = document.getElementById('requirePro');
      const loginBtn     = document.getElementById('loginBtn');
      const logoutBtn    = document.getElementById('logoutBtn');
      const userBox      = document.getElementById('userBox');
      const userEmailEl  = document.getElementById('userEmail');

      const heroSection  = document.getElementById('heroSection');
      const loadHeroBtn  = document.getElementById('loadHero');
      const heroBetEl    = document.getElementById('heroBet');

      loginBtn.addEventListener('click',  () => signIn().catch(console.error));
      logoutBtn.addEventListener('click', () => signOutUser().catch(console.error));

      function renderBoard(data) {
        const wrap = document.createElement('div');
        wrap.id = 'proBoard';

        if (!data || !Array.isArray(data.items) || data.items.length === 0) {
          wrap.innerHTML = '<div class="card">No qualifying fixtures for this date.</div>';
        } else {
          wrap.innerHTML = data.items.map(function(it){
            const top  = (it.topBets && it.topBets[0]) || null;
            const when = new Date(it.kickoff).toLocaleString();

            // build pick safely without nested template literals
            let pickDiv = '';
            if (top) {
              pickDiv =
                '<div style="margin-top:6px">' +
                  top.market + ': <b>' + top.pick + '</b> · <span>' + top.confidence + '%</span>' +
                '</div>';
            }

            const comp = (it.competition || (it.league && it.league.name) || '');

            return (
              '<div class="card" style="margin-bottom:12px">' +
                '<div><small>' + when + '</small></div>' +
                '<div><strong>' + it.home + '</strong> vs <strong>' + it.away + '</strong></div>' +
                '<div><small>' + comp + '</small></div>' +
                pickDiv +
              '</div>'
            );
          }).join('');
        }

        statusBox.insertAdjacentElement('afterend', wrap);
      }

      async function loadHero(token) {
        heroBetEl.innerHTML = 'Loading...';
        try {
          const resp = await fetch('/api/hero-bet', {
            headers: { Authorization: 'Bearer ' + token }
          });
          const raw = await resp.text();
          let j = null; try { j = JSON.parse(raw); } catch {}

          if (!resp.ok) {
            const msg = (j && (j.error || j.message)) || raw.slice(0,160);
            heroBetEl.innerHTML = '<div class="card">Error: ' + msg + '</div>';
            console.warn('hero-bet failed:', resp.status, raw);
            return;
          }

          const h = j.hero || j;
          const when = new Date(h.kickoff).toLocaleString();
          heroBetEl.innerHTML =
            '<div class="card">' +
              '<div><small>' + when + '</small></div>' +
              '<div><strong>' + h.match + '</strong> — ' + h.league + '</div>' +
              '<div style="margin-top:6px">' + h.market + ': <b>' + h.prediction + '</b> · <span>' + h.confidence + '%</span></div>' +
            '</div>';
        } catch (e) {
          heroBetEl.innerHTML = '<div class="card">Error: ' + e.message + '</div>';
        }
      }

      watchAuth(async (user) => {
        if (!user) {
          userBox.style.display = 'none';
          logoutBtn.hidden = true;
          loginBtn.hidden  = false;
          statusBox.textContent = 'Please sign in to view the Pro Board.';
          heroSection.style.display = 'none';
          return;
        }

        userBox.style.display = '';
        logoutBtn.hidden = false;
        loginBtn.hidden  = true;
        userEmailEl.textContent = user.email || '';

        try {
          const token = await getToken();
          const st = await fetch('/api/subscription/status?t=' + Date.now(), {
            headers: { Authorization: 'Bearer ' + token }
          });

          if (!st.ok) {
            const txt = await st.text().catch(() => '');
            statusBox.textContent = 'Could not verify subscription (' + st.status + ').';
            heroSection.style.display = 'none';
            console.warn('sub status failed:', st.status, txt);
            return;
          }

          const { active } = await st.json();
          if (!active) {
            statusBox.textContent = 'No active subscription.';
            heroSection.style.display = 'none';
            return;
          }

          statusBox.textContent = 'Loading Pro Board...';
          const pb = await fetch('/api/pro-board', {
            headers: { Authorization: 'Bearer ' + token }
          });

          if (!pb.ok) {
            const txt = await pb.text().catch(() => '');
            statusBox.textContent = 'Failed to load Pro Board (' + pb.status + ').';
            heroSection.style.display = 'none';
            console.warn('pro-board failed:', pb.status, txt);
            return;
          }

          const data = await pb.json();
          statusBox.style.display = 'none';
          renderBoard(data);

          // enable Hero section
          heroSection.style.display = '';
          loadHeroBtn.onclick = function(e){ e.preventDefault(); loadHero(token); };
        } catch (e) {
          console.error(e);
          statusBox.textContent = 'Error checking subscription.';
          heroSection.style.display = 'none';
        }
      });
    </script>
  </body>
</html>
