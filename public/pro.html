<!doctype html>
<html lang="en">
  <!-- Meta Pixel Code -->
  <script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window, document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '1135930111808538');
    fbq('track', 'PageView');
  </script>
  <noscript><img height="1" width="1" style="display:none"
  src="https://www.facebook.com/tr?id=1135930111808538&ev=PageView&noscript=1"
  /></noscript>
  <!-- End Meta Pixel Code -->
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Pro Board · OverEdge</title>
  <meta name="description" content="Hero Bet of the Day and full stats board for deeper picks."/>
  <link rel="stylesheet" href="/style.css"/>

  <!-- Favicons / icons -->
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/overedge-logo-512.png">

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-88C4MQ3EF8"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-88C4MQ3EF8');
  </script>

  <style>
    .grid-2 { display:grid; grid-template-columns:1fr auto; gap:.75rem; align-items:center; }
    .muted-sm { opacity:.7; font-size:.9rem; }
    .market-controls { display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; }

    .country-block { margin:1.25rem 0; }
    .country-header { display:flex; align-items:center; gap:.5rem; font-weight:700; font-size:1.05rem; margin:.25rem 0 .5rem; user-select:none; }
    .country-header img.flag{
      width:16px !important; height:12px !important; object-fit:cover;
      border:1px solid #e2e8f0; border-radius:2px; box-shadow:0 1px 0 rgba(0,0,0,.05);
    }

    details.comp-acc { border-radius:14px; background:#fff; box-shadow:0 6px 20px rgba(0,0,0,.06); margin:10px 0; border:1px solid #e6e8ee; }
    details.comp-acc > summary { list-style:none; cursor:pointer; padding:12px 14px; font-weight:700; display:flex; align-items:center; gap:8px; }
    details.comp-acc > summary::-webkit-details-marker { display:none; }
    details.comp-acc > summary::after { content:"▸"; margin-left:auto; opacity:.6; }
    details.comp-acc[open] > summary::after { content:"▾"; }
    .comp-count { opacity:.65; font-weight:600; }

    .teams { display:flex; align-items:center; gap:.45rem; flex-wrap:wrap; }
    .teams img.logo { width:18px; height:18px; object-fit:contain; }
    .teams .team { font-weight:900; letter-spacing:.02em; font-size:1.03rem; color:#0f172a; line-height:1.25; }
    .teams .sep { opacity:.55; padding:0 .15rem; }

    /* ✅ FIX: align-items START so right-side badges don't float in the middle */
    .fixture-row{
      display:grid;
      grid-template-columns: 1fr auto 26px;
      align-items:start;
      gap:.85rem;
      padding:.85rem 1rem;
      margin:.45rem 0;
      background:#fff;
      border:1px solid #e6e8ee;
      border-radius:16px;
      box-shadow: 0 1px 2px rgba(12,18,32,.06), 0 10px 22px rgba(12,18,32,.06);
      cursor:pointer;
    }
    /* ✅ NEW: highlight selected rows */
    .fixture-row.is-selected{
      border-color:#cfe4ff;
      box-shadow: 0 1px 2px rgba(12,18,32,.06), 0 10px 22px rgba(12,18,32,.10);
      outline:2px solid rgba(29,78,216,.12);
      background:#f8fbff;
    }

    .fixture-meta{ text-align:right; min-width:300px; align-self:start; }
    .fixture-pick { display:flex; justify-content:flex-end; }

    .badge-pick{
      display:inline-flex; align-items:center; gap:.4rem; padding:.26rem .65rem; border-radius:999px;
      font-weight:800; letter-spacing:.02em; background:#eff6ff; border:1px solid #cfe4ff; color:#1d4ed8;
      max-width:100%;
    }
    .badge-chip{
      display:inline-flex; align-items:center; gap:.35rem; padding:.20rem .55rem; border-radius:999px; font-weight:800;
      border:1px solid transparent;
      white-space:nowrap;
    }
    .badge-model{ background:#eef6ff; border-color:#cfe2ff; color:#0b57d0; }
    .badge-conf{ background:#e8f8ee; border-color:#cbead8; color:#166534; }
    .badge-fair{ background:#fff7ed; border-color:#fde2c7; color:#9a3412; }
    .badge-edge{ background:#f0fdf4; border-color:#dcfce7; color:#166534; }
    .badge-stake{ background:#eef2ff; border-color:#e0e7ff; color:#3730a3; }

    .legend { display:flex; gap:.75rem; align-items:center; flex-wrap:wrap; margin:.25rem 0 1rem; }
    .legend .label { font-weight:700; }
    .tooltip { position:relative; cursor:help; text-decoration:dotted underline; text-underline-offset:2px; }
    .tooltip[data-tip]::after{
      content:attr(data-tip);
      position:absolute; left:50%; transform:translateX(-50%); bottom:calc(100% + 8px);
      background:#0a0a0a; color:#fff; padding:.5rem .6rem; border-radius:8px; font-size:.86rem; line-height:1.2;
      opacity:0; pointer-events:none; white-space:normal; width:min(92vw,320px);
      box-shadow:0 8px 30px rgba(0,0,0,.18); transition:opacity .15s ease;
    }
    .tooltip:hover::after, .tooltip:focus::after{ opacity:1; }

    /* ✅ Cleaner xG line */
    .xg-line { margin-top:.25rem; font-size:.86rem; color:#64748b; }

    /* ✅ New stats layout */
    .stats-wrap{
      margin-top:.6rem;
      padding:.65rem .75rem;
      border:1px solid #eef2f7;
      background:#fbfcff;
      border-radius:14px;
    }
    .stats-title{
      font-weight:800;
      font-size:.9rem;
      color:#0f172a;
      margin-bottom:.45rem;
    }
    .stats-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:.6rem;
    }
    .team-box{
      background:#ffffff;
      border:1px solid #eef2f7;
      border-radius:12px;
      padding:.55rem .65rem;
    }
    .team-box__name{
      font-weight:900;
      font-size:.92rem;
      color:#0f172a;
      margin-bottom:.35rem;
    }
    .stat-row{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:.5rem;
      padding:.18rem 0;
      border-top:1px dashed rgba(15,23,42,.10);
      font-size:.9rem;
      color:#334155;
    }
    .stat-row:first-of-type{ border-top:none; }
    .stat-row b{ color:#0f172a; font-weight:900; }

    .matchup-row{
      margin-top:.55rem;
      font-size:.9rem;
      color:#475569;
      font-weight:700;
      display:flex;
      gap:.75rem;
      flex-wrap:wrap;
    }

    /* ✅ NEW: slip bar */
    .slipbar{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:14px;
      width:min(980px, calc(100% - 24px));
      background:#ffffff;
      border:1px solid #e6e8ee;
      border-radius:16px;
      box-shadow: 0 8px 30px rgba(12,18,32,.18);
      padding:.6rem .7rem;
      display:flex;
      align-items:center;
      gap:.6rem;
      z-index:9999;
    }
    .slipbar .spacer{ flex:1; }
    .slipbar .toast{ font-size:.9rem; opacity:.75; display:none; }

    /* ✅ Mobile: stack nicely */
    @media (max-width: 860px){
      .fixture-row{ grid-template-columns: 1fr; }
      .fixture-meta{ text-align:left; min-width:0; }
      .fixture-pick{ justify-content:flex-start; }
      .stats-grid{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<script defer src="/_vercel/speed-insights/script.js"></script>
<script src="/pixel.js" defer></script>
<script src="/social.js" defer></script>

<body>
  <header class="site-header">
    <nav class="nav">
      <a class="logo brand" href="/" aria-label="OverEdge">
        <img class="brand-img" src="/img/overedge-logo.png" alt="" />
        <span class="sr-only">OverEdge</span>
      </a>

      <div class="links">
        <a href="/free-picks">Free Picks</a>
        <a href="/pro" aria-current="page">Pro</a>
        <a href="/pricing">Pricing</a>
        <a href="/FAQ">FAQ</a>
        <a href="/results">Results</a>
        <a href="/account">Account</a>
      </div>
      <div class="auth" style="display:flex;align-items:center;gap:.5rem">
        <span id="nav-plan" class="badge pill" style="display:none"></span>
        <button id="nav-auth" class="btn small secondary" type="button">Sign In</button>
      </div>
    </nav>
  </header>

  <main>
    <!-- LOCKED VIEW -->
    <section id="locked" class="section" style="display:none">
      <h1>Pro is locked</h1>
      <p class="muted">Sign in with Google and subscribe to unlock the Pro Board and Hero Bet.</p>
      <p>
        <a class="btn" href="/account">Sign in</a>
        <a class="btn secondary" href="/pricing">Get Pro</a>
      </p>
    </section>

    <!-- PRO CONTENT -->
    <section id="proContent" class="section" style="display:none">
      <h1>Pro Board</h1>
      <p class="muted">
        Hero Bet of the Day and full team stats (5/10/15). Filters for Under/Over Goals, BTTS and 1X2 across top leagues.
      </p>

      <section class="section" style="padding-top:.5rem">
        <h2>Hero Bet of the Day</h2>
        <div id="hero" class="card" style="padding:1rem">Loading…</div>
        <p class="muted" style="margin-top:.5rem">Top-5 (and UEFA/FIFA) scope; youth leagues are excluded.</p>
      </section>

      <section class="section" style="padding-top:.5rem">
        <div class="grid-2" style="margin-bottom:.25rem">
          <h2 style="margin:0">Pro Board</h2>
          <div class="market-controls">
            <label for="boardMarket" class="muted-sm">Market:</label>
            <select id="boardMarket" class="market">
              <option value="ou_goals">Under/Over Goals</option>
              <option value="one_x_two">1X2</option>
              <option value="btts">BTTS — Yes/No</option>
            </select>
          </div>
        </div>

        <!-- Legend for the two percentages -->
        <div class="legend muted-sm">
          <span class="label">Legend:</span>
          <span class="badge-chip badge-model">
            Model probability
            <span class="tooltip" tabindex="0" data-tip="How often our algorithm expects this exact selection to hit based on recent form and team stats.">ⓘ</span>
          </span>
          <span class="badge-chip badge-conf">
            Pick confidence
            <span class="tooltip" tabindex="0" data-tip="Our conviction in recommending this pick today. Blends model probability with slate quality and variance controls.">ⓘ</span>
          </span>
          <span class="muted-sm" style="margin-left:auto">Tip: tap a row to add it to your slip.</span>
        </div>

        <div id="board" class="pro-board">Loading…</div>
      </section>
    </section>
  </main>

  <!-- ✅ NEW: Slip builder bar -->
  <div id="slipBar" class="slipbar" style="display:none">
    <span id="selCount" class="badge pill" style="display:none"></span>
    <div class="spacer"></div>
    <button id="btnCopySlip" class="btn small" type="button">Copy slip</button>
    <button id="btnClearSlip" class="btn small secondary" type="button">Clear</button>
    <span id="copyToast" class="toast">Copied</span>
  </div>

  <footer class="site-footer">
    <span>© <span id="y"></span> OverEdge — Data beats gut</span>
    <div class="contact">
      <a href="mailto:overedgestats@gmail.com">overedgestats@gmail.com</a>
      &nbsp;·&nbsp;
      <a href="https://www.facebook.com/profile.php?id=61579190114778" target="_blank" rel="noopener">Facebook</a>
      &nbsp;·&nbsp;
      <a href="https://www.instagram.com/overedgefootball" target="_blank" rel="noopener">@overedgefootball</a>
    </div>
  </footer>

  <!-- Firebase + gating + rendering -->
  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

    document.getElementById('y').textContent = new Date().getFullYear();

    const locked = document.getElementById('locked');
    const proContent = document.getElementById('proContent');
    const heroEl = document.getElementById('hero');
    const boardEl = document.getElementById('board');
    const boardMarketSel = document.getElementById('boardMarket');

    const navAuth = document.getElementById('nav-auth');
    const navPlan = document.getElementById('nav-plan');

    // ✅ Slip UI
    const slipBar = document.getElementById('slipBar');
    const selCountEl = document.getElementById('selCount');
    const btnCopySlip = document.getElementById('btnCopySlip');
    const btnClearSlip = document.getElementById('btnClearSlip');
    const copyToast = document.getElementById('copyToast');

    let auth = null;
    let currentUser = null;

    function tzGuess(){
      try { return Intl.DateTimeFormat().resolvedOptions().timeZone || "Europe/Sofia"; }
      catch { return "Europe/Sofia"; }
    }

    // ✅ Slip helpers
    function toast(msg = "Copied"){
      copyToast.textContent = msg;
      copyToast.style.display = "inline";
      clearTimeout(window.__oeToastT);
      window.__oeToastT = setTimeout(()=>{ copyToast.style.display="none"; }, 1100);
    }

    function updateSelCount(){
      const boxes = Array.from(document.querySelectorAll('.pick-checkbox'));
      const checked = boxes.filter(b => b.checked);

      // update row highlight
      boxes.forEach(cb => {
        const row = cb.closest('.fixture-row');
        if (row) row.classList.toggle('is-selected', !!cb.checked);
      });

      const n = checked.length;
      selCountEl.textContent = `${n} selected`;
      selCountEl.style.display = n ? 'inline-flex' : 'none';
      slipBar.style.display = n ? 'flex' : 'none';
    }

    function buildSlipText(){
      const checked = Array.from(document.querySelectorAll('.pick-checkbox:checked'));
      const lines = checked.map(cb => {
        const row = cb.closest('.fixture-row');
        const home = row?.dataset?.home || "";
        const away = row?.dataset?.away || "";
        const pick = row?.dataset?.pick || "";
        const time = row?.dataset?.time || "";
        const comp = row?.dataset?.comp || "";
        const bits = [];
        if (time) bits.push(time);
        if (comp) bits.push(comp);
        bits.push(`${home} vs ${away}`);
        if (pick) bits.push(`— ${pick}`);
        return bits.join(" · ");
      });

      // Nice header line
      const head = `OverEdge Slip (${new Date().toLocaleDateString("en-GB")})`;
      return [head, ...lines].join("\n");
    }

    btnCopySlip.addEventListener('click', async () => {
      try {
        const text = buildSlipText();
        await navigator.clipboard.writeText(text);
        toast("Copied");
      } catch {
        toast("Copy failed");
        alert("Could not copy. Your browser may block clipboard access.");
      }
    });

    btnClearSlip.addEventListener('click', () => {
      document.querySelectorAll('.pick-checkbox').forEach(cb => cb.checked = false);
      updateSelCount();
    });

    async function initFirebase() {
      const cfg = await fetch('/api/rpc?action=public-config').then(r => r.json()).then(d => d.firebase || {});
      if (!getApps().length) initializeApp(cfg);
      auth = getAuth();
      onAuthStateChanged(auth, u => {
        currentUser = u || null;
        updateNav();
        if (u) gateAndLoad(); else showLocked();
      });
    }

    function updateNav(){
      if (currentUser) {
        navAuth.textContent = "Sign Out";
        navAuth.onclick = async () => { try { await signOut(auth); } catch {} };
        try {
          const cache = JSON.parse(localStorage.getItem("oe.user") || "null");
          if (cache?.pro) {
            navPlan.textContent = cache.plan ? cache.plan : "Pro";
            navPlan.style.display="inline-block";
          } else {
            navPlan.textContent = "Free";
            navPlan.style.display="inline-block";
          }
        } catch { navPlan.style.display="none"; }
      } else {
        navAuth.textContent = "Sign In";
        navAuth.onclick = async () => {
          const provider = new GoogleAuthProvider();
          provider.setCustomParameters({ prompt: 'select_account' });
          try { await signInWithPopup(auth, provider); } catch { alert("Google sign-in failed."); }
        };
        navPlan.style.display="none";
      }
    }

    function showLocked(){
      locked.style.display = 'block';
      proContent.style.display = 'none';
      slipBar.style.display = 'none';
    }
    function showPro(){
      locked.style.display = 'none';
      proContent.style.display = 'block';
    }

    async function verifySub(email){
      const res = await fetch(`/api/rpc?action=verify-sub&email=${encodeURIComponent(email)}`);
      return res.ok ? res.json() : { pro:false, plan:null, status:"unknown" };
    }

    async function gateAndLoad(){
      if (!currentUser) return showLocked();
      const sub = await verifySub(currentUser.email);
      try {
        localStorage.setItem("oe.user", JSON.stringify({
          email: currentUser.email,
          uid: currentUser.uid,
          pro: !!sub.pro,
          plan: sub.plan || null
        }));
      } catch {}
      if (!sub.pro) return showLocked();
      showPro();
      loadHero();
      await loadBoardGrouped();
    }

    function heroCard(h){
      if (!h || !h.heroBet) return `<p>Coming soon (no qualifying value pick yet).</p>`;
      const p = h.heroBet;

      const modelProb = (typeof p.modelProbPct === 'number' && p.modelProbPct > 0 && p.modelProbPct < 100)
        ? (p.modelProbPct / 100)
        : null;

      let fair = null;
      let edge = null;
      let stakeGuide = null;

      if (modelProb && typeof p.odds === 'number' && p.odds > 1) {
        fair = 1 / modelProb;
        edge = p.odds - fair;

        const conf = p.confidencePct || 0;
        if (conf >= 80 && edge >= 0.20) stakeGuide = "High";
        else if (conf >= 70 && edge >= 0.10) stakeGuide = "Medium";
        else stakeGuide = "Low";
      }

      const chips = [];
      if (typeof p.modelProbPct === 'number') chips.push(`<span class="badge-chip badge-model">Model ${p.modelProbPct}%</span>`);
      if (typeof p.confidencePct === 'number') chips.push(`<span class="badge-chip badge-conf">Confidence ${p.confidencePct}%</span>`);
      if (typeof fair === 'number') chips.push(`<span class="badge-chip badge-fair">Fair ${fair.toFixed(2)}</span>`);
      if (typeof edge === 'number') chips.push(`<span class="badge-chip badge-edge">Edge ${(edge >= 0 ? '+' : '')}${edge.toFixed(2)}</span>`);
      if (stakeGuide) chips.push(`<span class="badge-chip badge-stake">Stake ${stakeGuide}</span>`);

      const trend = p.histTrend || p.trend || p.reasoning || "";
      const priceStr = (typeof p.odds === 'number' && p.odds > 1)
        ? ` @ <span style="font-weight:700">${p.odds.toFixed(2)}</span>`
        : "";

      return `
        <div class="grid-2">
          <div>
            <div style="font-weight:600">${p.country ? `${p.country} — ` : ""}${p.league}</div>
            <div class="muted-sm">${p.matchTime} — <strong>${p.home}</strong> vs <strong>${p.away}</strong></div>
            <div class="muted-sm" style="margin-top:.25rem">
              <strong>${p.selection || p.market || "—"}</strong>${priceStr}
            </div>
          </div>
          <div style="text-align:right; display:flex; gap:.35rem; flex-wrap:wrap; justify-content:flex-end">
            ${chips.join('')}
          </div>
        </div>
        <div style="margin-top:.5rem">${trend}</div>
      `;
    }

    async function loadHero(){
      try {
        heroEl.innerHTML = "Loading…";
        const res = await fetch(`/api/rpc?action=pro-pick&tz=${encodeURIComponent(tzGuess())}`);
        const data = await res.json();
        heroEl.innerHTML = heroCard(data);
      } catch {
        heroEl.innerHTML = "<p>Could not load hero bet.</p>";
      }
    }

    boardMarketSel.addEventListener('change', loadBoardGrouped);

    // helpers for stats formatting
    const fmtPct = (v) =>
      (typeof v === 'number' && !Number.isNaN(v))
        ? `${Math.round(Math.max(0, Math.min(1, v)) * 100)}%`
        : '—';

    const fmtNum1 = (v) =>
      (typeof v === 'number' && !Number.isNaN(v))
        ? v.toFixed(1)
        : '—';

    function renderGroupedBoard(payload){
      if (!payload || !payload.groups || !payload.groups.length) {
        boardEl.innerHTML = "<p>No matches found today.</p>";
        updateSelCount();
        return;
      }

      const container = document.createDocumentFragment();

      payload.groups.forEach(group => {
        const countryWrap = document.createElement('div');
        countryWrap.className = 'country-block';
        countryWrap.innerHTML = `
          <div class="country-header">
            ${group.flag ? `<img class="flag" src="${group.flag}" alt="${group.country} flag" loading="lazy" onerror="this.style.display='none'">` : ""}
            <span>${group.country}</span>
          </div>
        `;

        (group.leagues || []).forEach(L => {
          const acc = document.createElement('details');
          acc.className = 'comp-acc';

          const summary = document.createElement('summary');
          const fxCount = (L.fixtures || []).length;
          summary.innerHTML = `<span>${L.leagueName || 'League'}</span><span class="comp-count">(${fxCount})</span>`;
          acc.appendChild(summary);

          const list = document.createElement('div');
          list.className = 'comp-list';

          (L.fixtures || []).forEach(fx => {
            const rec = fx.recommendation;
            if (!rec) return;

            const row = document.createElement('div');
            row.className = 'fixture-row';

            const pickLabel = `${rec.market}${rec.pick ? ` — ${rec.pick}` : ""}`;
            const conf = (typeof rec.confidencePct === 'number') ? rec.confidencePct : null;
            const model = (typeof rec.modelProbPct === 'number') ? rec.modelProbPct : conf;

            const s = fx.stats || null;

            const hasXg = (typeof fx.xgHome === 'number' && typeof fx.xgAway === 'number')
              || (fx.xg && typeof fx.xg.home === 'number' && typeof fx.xg.away === 'number');

            const xgH = fx.xg?.home ?? fx.xgHome;
            const xgA = fx.xg?.away ?? fx.xgAway;

            const xgLine = hasXg
              ? `<div class="xg-line">Expected goals (xG): ${fmtNum1(xgH)} – ${fmtNum1(xgA)}</div>`
              : "";

            let statsHtml = "";
            if (s) {
              const sample = s.sampleSize || 'N';
              const homeName = fx.home?.name || '';
              const awayName = fx.away?.name || '';
              statsHtml = `
                <div class="stats-wrap">
                  <div class="stats-title">Last ${sample} matches</div>

                  <div class="stats-grid">
                    <div class="team-box">
                      <div class="team-box__name">${homeName}</div>
                      <div class="stat-row"><span>Goals for (avg)</span><b>${fmtNum1(s.home.avgGoalsFor)}</b></div>
                      <div class="stat-row"><span>Goals against (avg)</span><b>${fmtNum1(s.home.avgGoalsAgainst)}</b></div>
                      <div class="stat-row"><span>Clean sheets</span><b>${fmtPct(s.home.cleanSheetRate)}</b></div>
                      <div class="stat-row"><span>Failed to score</span><b>${fmtPct(s.home.failToScoreRate)}</b></div>
                      <div class="stat-row"><span>Points per game</span><b>${fmtNum1(s.home.ppg)}</b></div>
                    </div>

                    <div class="team-box">
                      <div class="team-box__name">${awayName}</div>
                      <div class="stat-row"><span>Goals for (avg)</span><b>${fmtNum1(s.away.avgGoalsFor)}</b></div>
                      <div class="stat-row"><span>Goals against (avg)</span><b>${fmtNum1(s.away.avgGoalsAgainst)}</b></div>
                      <div class="stat-row"><span>Clean sheets</span><b>${fmtPct(s.away.cleanSheetRate)}</b></div>
                      <div class="stat-row"><span>Failed to score</span><b>${fmtPct(s.away.failToScoreRate)}</b></div>
                      <div class="stat-row"><span>Points per game</span><b>${fmtNum1(s.away.ppg)}</b></div>
                    </div>
                  </div>

                  <div class="matchup-row">
                    <span>Over 2.5 likelihood: <b>${fmtPct(s.matchup.over25Likelihood)}</b></span>
                    <span>BTTS likelihood: <b>${fmtPct(s.matchup.bttsLikelihood)}</b></span>
                  </div>
                </div>
              `;
            }

            const left = document.createElement('div');
            left.innerHTML = `
              <div class="teams">
                ${fx.home?.logo ? `<img class="logo" src="${fx.home.logo}" alt="">` : ""}<span class="team">${fx.home?.name || ""}</span>
                <span class="sep">vs</span>
                ${fx.away?.logo ? `<img class="logo" src="${fx.away.logo}" alt="">` : ""}<span class="team">${fx.away?.name || ""}</span>
              </div>
              ${xgLine}
              ${statsHtml}
            `;

            const meta = document.createElement('div');
            meta.className = 'fixture-meta';
            meta.innerHTML = `
              <div class="muted-sm">${fx.time || ""}</div>
              <div class="fixture-pick" style="margin-top:.4rem">
                <span class="badge-pick">${pickLabel}</span>
              </div>
              <div style="margin-top:.45rem; display:flex; gap:.35rem; justify-content:flex-end; flex-wrap:wrap">
                <span class="badge-chip badge-model">
                  Model ${typeof model==='number' ? `${model}%` : '—'}
                  <span class="tooltip" tabindex="0" data-tip="Model probability: how often our algorithm expects this selection to hit based on recent form and team stats.">ⓘ</span>
                </span>
                <span class="badge-chip badge-conf">
                  Confidence ${typeof conf==='number' ? `${conf}%` : '—'}
                  <span class="tooltip" tabindex="0" data-tip="Pick confidence: our conviction in recommending this today (model + slate quality + variance controls).">ⓘ</span>
                </span>
              </div>
            `;

            const right = document.createElement('div');
            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.className = 'pick-checkbox';
            cb.setAttribute('aria-label', 'Add pick to slip');
            right.appendChild(cb);

            // ✅ attach dataset for slip copy
            row.dataset.home = fx.home?.name || "";
            row.dataset.away = fx.away?.name || "";
            row.dataset.time = fx.time || "";
            row.dataset.comp = L.leagueName || "";
            row.dataset.pick = pickLabel;

            // ✅ click row toggles checkbox (but not when clicking checkbox itself)
            row.addEventListener('click', (e) => {
              const t = e.target;
              if (t && (t.tagName === 'INPUT' || t.tagName === 'BUTTON' || t.tagName === 'A' || t.closest('button') || t.closest('a'))) return;
              cb.checked = !cb.checked;
              updateSelCount();
            });

            cb.addEventListener('change', updateSelCount);

            row.appendChild(left);
            row.appendChild(meta);
            row.appendChild(right);

            list.appendChild(row);
          });

          acc.appendChild(list);
          countryWrap.appendChild(acc);
        });

        container.appendChild(countryWrap);
      });

      boardEl.innerHTML = "";
      boardEl.appendChild(container);
      updateSelCount();
    }

    async function loadBoardGrouped(){
      try {
        boardEl.innerHTML = "Loading…";
        const market = boardMarketSel.value;

        // NOTE: keeping refresh=1 since you had it; remove if you want caching to work harder.
        const res = await fetch(`/api/rpc?action=pro-board-grouped&market=${encodeURIComponent(market)}&tz=${encodeURIComponent(tzGuess())}&refresh=1`);
        const data = await res.json();
        renderGroupedBoard(data);
      } catch {
        boardEl.innerHTML = "<p>Could not load Pro Board.</p>";
        updateSelCount();
      }
    }

    // boot
    initFirebase();
  </script>

  <!-- Shared navbar auth module -->
  <script type="module" src="/auth.js"></script>
</body>
</html>
